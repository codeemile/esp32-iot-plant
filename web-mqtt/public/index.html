<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ðŸŒ± ESP32 Plant Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: Arial;
      text-align: center;
    }
    .card {
      background: #020617;
      padding: 20px;
      margin: 20px auto;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
    }
    .sensor-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    .sensor-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s;
      margin: 10px;
    }
    .sensor-circle:hover {
      transform: scale(1.05);
    }
    .sensor-circle.not-button {
      cursor: default;
    }
    .sensor-circle.not-button:hover {
      transform: none;
    }
    .sensor-circle svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }
    .sensor-circle circle {
      fill: none;
      stroke-width: 8;
    }
    .sensor-bg {
      stroke: #374151;
    }
    .sensor-progress.led-on {
      stroke: #10b981; /* green */
    }
    .sensor-progress.led-off {
      stroke: #dc2626; /* red */
    }
    .sensor-progress.fan-on {
      stroke: #10b981;
    }
    .sensor-progress.fan-off {
      stroke: #dc2626;
    }
    .sensor-progress.co2 {
      /* default, no stroke */
    }
    .sensor-progress.co2-low {
      stroke: #dc2626 !important; /* red for low */
    }
    .sensor-progress.co2-good {
      stroke: #10b981 !important; /* green for good */
    }
    .sensor-progress.co2-high {
      stroke: #dc2626 !important; /* red for high */
    }
    .sensor-progress.soil {
      stroke: #10b981; /* green for soil */
    }
    .sensor-progress.rssi {
      /* stroke set by JS */
    }
    .sensor-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 14px;
      font-weight: bold;
    }
    .sensor-label {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      text-align: center;
    }
    .fan-indicator {
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: bold;
    }
    .fan-indicator.on {
      color: #10b981; /* green */
    }
    .fan-indicator.off {
      color: #6b7280; /* gray */
    }
    
    .alert {
      display: none;
    }
    h2 {
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>

<h1>ðŸŒ¿ Serre ConnectÃ©e</h1>

<div class="card">
  <div class="sensor-container">
    <div class="sensor-circle" id="lux-circle" onclick="toggleLED()">
      <svg>
        <circle class="sensor-bg" cx="60" cy="60" r="50"></circle>
        <circle class="sensor-progress led-off" cx="60" cy="60" r="50" id="lux-progress" stroke-dasharray="0 314"></circle>
      </svg>
      <div class="sensor-label">LuminositÃ©</div>
      <div class="sensor-value" id="lux">-</div>
      <div class="fan-indicator off" id="led-indicator">OFF</div>
    </div>
    <div class="sensor-circle" id="soil-circle" onclick="toggleHumidifier()">
      <svg>
        <circle class="sensor-bg" cx="60" cy="60" r="50"></circle>
        <circle class="sensor-progress soil" cx="60" cy="60" r="50" id="soil-progress" stroke-dasharray="0 314"></circle>
      </svg>
      <div class="sensor-label">HumiditÃ©</div>
      <div class="sensor-value" id="soil">-</div>
      <div class="fan-indicator off" id="humidifier-indicator">OFF</div>
    </div>
    <div class="sensor-circle" id="co2-circle" onclick="toggleFan()">
      <svg>
        <circle class="sensor-bg" cx="60" cy="60" r="50"></circle>
        <circle class="sensor-progress co2" cx="60" cy="60" r="50" id="co2-progress" stroke-dasharray="0 314"></circle>
      </svg>
      <div class="sensor-label">CO2</div>
      <div class="sensor-value" id="co2">-</div>
      <div class="fan-indicator off" id="fan-indicator">OFF</div>
    </div>
    <div class="sensor-circle not-button">
      <svg>
        <circle class="sensor-bg" cx="60" cy="60" r="50"></circle>
        <circle class="sensor-progress rssi" cx="60" cy="60" r="50" id="rssi-progress" stroke-dasharray="0 314"></circle>
      </svg>
      <div class="sensor-label">WiFi</div>
      <div class="sensor-value" id="rssi">-</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>ðŸ“ˆ Historique</h2>
  <canvas id="historyChart" width="350" height="150"></canvas>
</div>

<div id="alertBox" class="alert" style="display: none;"></div>

<script>
  const socket = io();
  let historyChart;
  let ledState = false;
  let fanState = false;
  let humidifierState = false;

  function updateSensor(sensorId, value, maxValue = 100) {
    const valueEl = document.getElementById(sensorId);
    const progressEl = document.getElementById(sensorId + '-progress');
    const circumference = 2 * Math.PI * 50; // r=50
    let percentage = Math.min(Math.max(value / maxValue * 100, 0), 100);
    progressEl.style.strokeDasharray = `${percentage / 100 * circumference} ${circumference}`;
    let unit = "";
    if (sensorId === 'soil') unit = " %";
    valueEl.innerText = value.toFixed(1) + unit;
  }

  function toggleLED() {
    ledState = !ledState;
    const indicatorEl = document.getElementById('led-indicator');
    indicatorEl.className = 'fan-indicator ' + (ledState ? 'on' : 'off');
    indicatorEl.innerText = ledState ? 'ON' : 'OFF';
    send(ledState ? 'LED_ON' : 'LED_OFF');
  }

  function toggleHumidifier() {
    humidifierState = !humidifierState;
    const indicatorEl = document.getElementById('humidifier-indicator');
    indicatorEl.className = 'fan-indicator ' + (humidifierState ? 'on' : 'off');
    indicatorEl.innerText = humidifierState ? 'ON' : 'OFF';
    send(humidifierState ? 'HUM_ON' : 'HUM_OFF');
  }

  socket.on('telemetry', data => {
    const circumference = 2 * Math.PI * 50; // r=50

    // Pour luminositÃ©, Ã©chelle logarithmique de 0 Ã  65000 lux
    let luxValue = data.luminosite;
    let luxPercentage = 0;
    if (luxValue <= 0) {
      luxPercentage = 0;
    } else if (luxValue > 65000) {
      luxPercentage = 100;
    } else {
      luxPercentage = (Math.log10(luxValue + 1) / Math.log10(65001)) * 100;
    }
    const luxProgressEl = document.getElementById('lux-progress');
    luxProgressEl.style.strokeDasharray = `${luxPercentage / 100 * circumference} ${circumference}`;
    // Couleur selon niveau luminositÃ© pour plante
    let luxColor = '#dc2626'; // red default
    if (luxValue >= 500 && luxValue <= 10000) {
      luxColor = '#10b981'; // green for good
    }
    luxProgressEl.style.stroke = luxColor;
    document.getElementById('lux').innerText = luxValue.toFixed(1) + " lux";

    updateSensor('soil', data.humidite_sol);
    // Couleur pour humiditÃ©
    let soilValue = data.humidite_sol;
    let soilColor = '#dc2626'; // red default
    if (soilValue >= 30 && soilValue <= 70) {
      soilColor = '#10b981'; // green for good
    }
    document.getElementById('soil-progress').style.stroke = soilColor;
    // Pour CO2, Ã©chelle pour serre : 200 Ã  1500 ppm
    let co2Value = data.co2;
    let co2Percentage = Math.min(Math.max((co2Value - 200) / (1500 - 200) * 100, 0), 100);
    const co2ProgressEl = document.getElementById('co2-progress');
    co2ProgressEl.style.strokeDasharray = `${co2Percentage / 100 * circumference} ${circumference}`;
    // Couleur selon niveau CO2
    let color = '#10b981'; // green for good
    if (co2Value < 400) {
      color = '#dc2626'; // red for low
    } else if (co2Value > 1200) {
      color = '#dc2626'; // red for high
    }
    co2ProgressEl.style.stroke = color;
    document.getElementById('co2').innerText = co2Value.toFixed(1) + " ppm";
    // Pour RSSI, Ã©chelle de 0 Ã  -100 dB (100% = -30dB excellent, 0% = -100dB faible)
    const rssiValue = data.rssi;
    const rssiPercent = Math.max(0, (rssiValue + 100) / 70 * 100);
    const rssiProgressEl = document.getElementById('rssi-progress');
    rssiProgressEl.style.strokeDasharray = `${rssiPercent / 100 * circumference} ${circumference}`;
    // Couleur selon pourcentage RSSI
    let rssiColor = '#dc2626'; // red for low percentage (bad signal)
    if (rssiPercent > 70) {
      rssiColor = '#10b981'; // green for high percentage (good signal)
    } else if (rssiPercent > 30) {
      rssiColor = '#f59e0b'; // yellow for medium
    }
    rssiProgressEl.style.stroke = rssiColor;
    document.getElementById('rssi').innerText = rssiValue + " dB";
  });

  socket.on('alert', alertData => {
    // Alerte supprimÃ©e
  });

  function send(cmd) {
    socket.emit('cmd', cmd);
  }

  function loadHistory() {
    fetch('/api/history')
      .then(res => res.json())
      .then(data => {
        if (data.length === 0) return;

        const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString()).reverse();
        const luxData = data.map(d => d.luminosite).reverse();
        const soilData = data.map(d => d.humidite_sol).reverse();
        const co2Data = data.map(d => d.co2).reverse();

        if (historyChart) {
          historyChart.destroy();
        }

        historyChart = new Chart(document.getElementById('historyChart'), {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'LuminositÃ© (lux)',
                data: luxData,
                borderColor: 'yellow',
                fill: false
              },
              {
                label: 'HumiditÃ© Sol (%)',
                data: soilData,
                borderColor: 'blue',
                fill: false
              },
              {
                label: 'CO2 (ppm)',
                data: co2Data,
                borderColor: 'green',
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              x: { display: true },
              y: { display: true }
            }
          }
        });
      });
  }

  // Charger l'historique au dÃ©marrage
  loadHistory();

  // RafraÃ®chir automatiquement toutes les 30 secondes
  setInterval(loadHistory, 5000);
</script>

</body>
</html>
